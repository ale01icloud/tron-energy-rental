# 国家费率/汇率功能测试说明

## 📋 功能逻辑

### 1️⃣ 通用费率（默认费率）
- **用途**：当交易**不指定国家**时使用
- **设置命令**：
  - `设置入金费率 10` - 设置默认入金费率10%
  - `设置入金汇率 7.0` - 设置默认入金汇率7.0
  - `设置出金费率 5` - 设置默认出金费率5%
  - `设置出金汇率 7.2` - 设置默认出金汇率7.2

### 2️⃣ 国家特定费率
- **用途**：当交易**指定国家**时优先使用
- **设置命令**：
  - `设置 美国 入 费率 15` - 设置美国入金费率15%
  - `设置 美国 入 汇率 7.1` - 设置美国入金汇率7.1
  - `设置 日本 出 费率 8` - 设置日本出金费率8%

## 🧪 测试场景

### 场景1：通用费率测试
```
1. 设置默认费率
   - 发送：设置入金费率 10
   - 发送：设置入金汇率 7.0

2. 使用通用费率入金
   - 发送：+1000
   - 预期：使用默认费率10%和汇率7.0计算
   - 计算：1000 × (1-0.10) / 7.0 = 128.57 USDT
```

### 场景2：国家费率测试
```
1. 设置美国特定费率
   - 发送：设置 美国 入 费率 15
   - 发送：设置 美国 入 汇率 7.1

2. 使用美国费率入金
   - 发送：+1000/美国
   - 预期：使用美国费率15%和汇率7.1计算
   - 计算：1000 × (1-0.15) / 7.1 = 119.72 USDT

3. 使用通用费率入金（不指定国家）
   - 发送：+1000
   - 预期：仍使用默认费率10%和汇率7.0
   - 计算：1000 × (1-0.10) / 7.0 = 128.57 USDT
```

### 场景3：多国家独立测试
```
1. 设置多个国家费率
   - 发送：设置 美国 入 费率 15
   - 发送：设置 日本 入 费率 12
   - 发送：设置 英国 入 费率 18

2. 分别测试
   - +1000/美国 → 使用15%费率
   - +1000/日本 → 使用12%费率
   - +1000/英国 → 使用18%费率
   - +1000     → 使用默认10%费率
```

### 场景4：国家未设置时的回退
```
1. 只设置默认费率，不设置国家费率
   - 发送：设置入金费率 10
   - 发送：设置入金汇率 7.0

2. 使用未设置的国家
   - 发送：+1000/德国
   - 预期：德国未设置，自动回退到默认费率
   - 计算：1000 × (1-0.10) / 7.0 = 128.57 USDT
```

## 🔍 代码实现逻辑

### 解析函数 `parse_amount_and_country(text)`
```python
# 输入："+1000/美国"
# 输出：amount=1000, country="美国"

# 输入："+1000"  
# 输出：amount=1000, country=None
```

### 费率解析 `resolve_params(chat_id, direction, country)`
```python
# 优先级：
# 1. 国家特定费率/汇率（如果country不为None且已配置）
# 2. 默认费率/汇率（回退方案）

if country and country in countries:
    # 优先使用国家配置
    if direction in countries[country]:
        d["rate"] = countries[country][direction].get("rate", None)
        d["fx"]   = countries[country][direction].get("fx", None)
    
# 如果国家未配置，使用默认
if d["rate"] is None: 
    d["rate"] = state["defaults"][direction]["rate"]
if d["fx"] is None: 
    d["fx"] = state["defaults"][direction]["fx"]
```

## ✅ 验证要点

1. **国家特定费率与通用费率完全独立**
   - 设置美国费率不影响默认费率
   - +1000/美国 和 +1000 使用不同的费率

2. **日志文件分类存储**
   - +1000/美国 → 日志存储在 `data/logs/group_xxx/美国/`
   - +1000 → 日志存储在 `data/logs/group_xxx/通用/`

3. **多群组独立**
   - 群组A的美国费率不影响群组B
   - 每个群组可以有自己的国家费率配置

## 🎯 结论

国家费率功能逻辑**完全正确**：
- ✅ 带国家标记（+1000/美国）→ 使用国家费率
- ✅ 不带国家标记（+1000）→ 使用通用费率
- ✅ 国家未配置时自动回退到默认费率
- ✅ 多群组独立，互不干扰
