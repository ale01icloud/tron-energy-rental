# 财务记账 Telegram 机器人 💰

这是一个功能强大的 Telegram 财务记账机器人，专为处理入金/出金记录和汇率计算而设计。

## 🎯 主要功能

### 📊 记账功能
- **入金记录**：自动计算USDT金额（扣除费率和汇率转换）
- **出金记录**：自动计算下发USDT金额
- **账单汇总**：实时显示最近5笔入金和出金记录
- **历史追踪**：自动保存每日账单到日志文件

### ⚙️ 灵活配置
- 支持国家/地区特定的费率和汇率设置
- 默认费率：入金 10%，出金 -2%
- 默认汇率：入金 153，出金 137
- 可按国家定制不同的参数

### 👥 管理员系统
- 超级管理员（OWNER_ID）拥有永久权限
- 支持添加/删除普通管理员
- 管理员可以修改费率和汇率设置

## 🚀 使用方法

### 基本操作

**入金**（法币→USDT）
```
+10000          # 通用入金
+10000 / 日本   # 指定国家入金
```

**出金**（USDT→法币）
```
-10000          # 通用出金
-10000 / 日本   # 指定国家出金
```

**查看账单**
```
更多账单
显示历史账单
```

### 设置命令（仅管理员）

**修改费率**
```
设置 默认 入 费率 10
设置 日本 入 费率 8
设置 默认 出 费率 -2
```

**修改汇率**
```
设置 默认 入 汇率 153
设置 日本 入 汇率 127
设置 默认 出 汇率 137
```

### 管理员管理

**查看管理员列表**
```
显示机器人管理员
```

**添加管理员**
1. 回复要授权用户的消息
2. 发送：`设置机器人管理员`

**删除管理员**
1. 回复要移除权限用户的消息
2. 发送：`删除机器人管理员`

## 📁 项目结构

```
.
├── bot.py              # 主程序
├── requirements.txt    # Python 依赖
├── data/              # 数据目录（自动创建）
│   ├── state.json     # 状态数据
│   ├── admins.json    # 管理员列表
│   └── logs/          # 日志文件
│       ├── 通用/      # 通用记录
│       ├── 日本/      # 日本记录
│       └── ...        # 其他国家
└── README.md          # 本文件
```

## 🔧 配置说明

### 环境变量

必需的环境变量：
- `TELEGRAM_BOT_TOKEN` - 您的 Telegram Bot Token（已配置）

可选的环境变量：
- `OWNER_ID` - 超级管理员的 Telegram 用户ID
- `PORT` - HTTP 保活服务器端口（默认：5000）

### 数据持久化

- **状态文件** (`data/state.json`)：存储费率、汇率、近期记录等
- **管理员文件** (`data/admins.json`)：存储管理员ID列表
- **日志文件** (`data/logs/`)：按国家和日期分类存储详细记录

## 📊 账单格式

机器人会显示如下格式的账单汇总：

```
📊【@Finance_Bot 账单汇总】

📥 入金记录（最近5笔）
🕐 14:30　+10000 → 58.82 USDT

📤 下发记录（最近5笔）
🕐 14:35　73.00 USDT

━━━━━━━━━━━━━━
⚙️ 当前费率：入 10% ⇄ 出 -2%
💱 固定汇率：入 153 ⇄ 出 137
📊 应下发：58.82 USDT
📤 已下发：73.00 USDT
✅ 未下发：-14.18 USDT
━━━━━━━━━━━━━━
📚 **查看更多账单**：发送「更多账单」或「显示历史账单」
```

## 🔐 安全特性

- 管理员权限控制
- 环境变量安全存储
- 数据本地持久化
- HTTP 保活服务（防止机器人休眠）

## 🛠️ 技术栈

- **Python 3.11**
- **python-telegram-bot** - Telegram Bot API
- **Flask** - HTTP 保活服务器
- **python-dotenv** - 环境变量管理

## 📝 日志示例

日志文件格式（自动保存到 `data/logs/国家/日期.log`）：

```
[入金] 时间:14:30 国家:日本 原始:10000 汇率:153 费率:10.00% 结果:58.82
[出金] 时间:14:35 国家:日本 原始:10000 汇率:137 费率:-2.00% 下发:73.00
```

## 🚦 运行状态

机器人当前运行状态：
- ✅ Telegram Bot 正在监听消息
- ✅ HTTP 服务器运行在 5000 端口
- ✅ 数据自动保存和恢复

访问 `http://localhost:5000` 可以查看保活状态（返回 "ok"）。

## 💡 提示

1. 所有金额计算使用**截断**方式（不四舍五入）保留两位小数
2. 费率以百分比输入，系统自动转换（如：10 = 10%）
3. 可以为不同国家设置不同的费率和汇率
4. 日志文件按国家和日期自动分类保存
5. 超级管理员权限永久有效，无法被删除

## 📞 获取帮助

在 Telegram 中向机器人发送 `/start` 查看使用说明。
